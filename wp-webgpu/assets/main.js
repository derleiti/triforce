async function P(g){const o=await navigator.gpu.requestAdapter({powerPreference:"high-performance"});if(!o)throw new Error("Kein WebGPU-Adapter.");const e=await o.requestDevice(),r=g.getContext("webgpu"),s=navigator.gpu.getPreferredCanvasFormat();r.configure({device:e,format:s,alphaMode:"premultiplied"});const t=e.createSampler({minFilter:"linear",magFilter:"linear"}),u=e.createShaderModule({code:`
      struct VSOut { @builtin(position) pos: vec4<f32>; @location(0) uv: vec2<f32>; };
      @vertex
      fn vs_main(@builtin(vertex_index) in: u32) -> VSOut {
        var out: VSOut;
        let uv = vec2<f32>(f32(in & 1u), f32(in >> 1u));
        out.pos = vec4<f32>(uv * 2.0 - 1.0, 0.0, 1.0);
        out.uv = uv;
        return out;
      }
      ${await(await fetch("./render/filters.wgsl")).text()}
    `}),d=e.createRenderPipeline({layout:"auto",vertex:{module:u,entryPoint:"vs_main"},fragment:{module:u,entryPoint:"fs_main",targets:[{format:s}]},primitive:{topology:"triangle-strip"}}),a=e.createTexture({size:[1,1],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST}).createView(),c=e.createBuffer({size:4*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),f=e.createBindGroup({layout:d.getBindGroupLayout(0),entries:[{binding:0,resource:t},{binding:1,resource:a},{binding:2,resource:{buffer:c}}]}),i=e.createShaderModule({code:`
      ${await(await fetch("./compute/resize.wgsl")).text()}
    `}),l=e.createComputePipeline({layout:"auto",compute:{module:i,entryPoint:"main"}}),m=e.createBuffer({size:4*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),T=e.createBuffer({size:4*Uint32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),h=e.createBindGroup({layout:l.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:m}},{binding:1,resource:{buffer:m}},{binding:2,resource:{buffer:T}}]});return{device:e,filterPipeline:d,filterBindGroup:f,resizePipeline:l,resizeBindGroup:h,sampler:t}}function U(g,o,e){const r=e.getContext("2d");r.fillStyle="black",r.fillRect(0,0,e.width,e.height);let s=!1,t=24;const u=document.createElement("input");u.type="range",u.min="4",u.max="64",u.value=String(t),u.oninput=()=>t=parseInt(u.value,10);const d=document.createElement("button");d.textContent="Maske exportieren & Inpaint",e.addEventListener("pointerdown",a=>{s=!0,n(a)}),e.addEventListener("pointermove",a=>{s&&n(a)}),window.addEventListener("pointerup",()=>s=!1);function n(a){const c=e.getBoundingClientRect(),f=(a.clientX-c.left)*e.width/c.width,i=(a.clientY-c.top)*e.height/c.height;r.fillStyle="white",r.beginPath(),r.arc(f,i,t,0,Math.PI*2),r.fill()}d.onclick=async()=>{if(!window.NOVA_AI_CFG||!window.NOVA_AI_CFG.apiBase||!window.NOVA_AI_CFG.nonce){console.error("NOVA_AI_CFG ist nicht korrekt initialisiert."),alert("Fehler: Plugin-Konfiguration fehlt.");return}const a=await new Promise(i=>e.toBlob(l=>i(l),"image/png")),c=await new Promise(i=>o.toBlob(l=>i(l),"image/png"));if(!a||!c){alert("Fehler beim Erstellen der Blobs.");return}const f=new FormData;f.append("image",c,"image.png"),f.append("mask",a,"mask.png"),f.append("prompt","Ein schönes Bild mit Inpainting"),f.append("strength","0.7");try{const i=await fetch(`${window.NOVA_AI_CFG.apiBase}/sd3/mask-inpaint`,{method:"POST",body:f,headers:{"X-WP-Nonce":window.NOVA_AI_CFG.nonce}});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const l=await i.json();console.log("Inpaint-Ergebnis:",l),alert(`Inpainting erfolgreich! Bild-URL: ${l.image_url}`)}catch(i){console.error("Fehler beim Inpainting:",i),alert(`Fehler beim Inpainting: ${i instanceof Error?i.message:String(i)}`)}},g.append(u,d)}function w(g,o){const e=o.getContext("2d"),r=document.createElement("button");r.textContent="Overlay aktualisieren",r.onclick=async()=>{if(e.clearRect(0,0,o.width,o.height),!window.NOVA_AI_CFG||!window.NOVA_AI_CFG.apiBase||!window.NOVA_AI_CFG.nonce){console.error("NOVA_AI_CFG ist nicht korrekt initialisiert."),alert("Fehler: Plugin-Konfiguration fehlt.");return}const s={image_url:"demo_image_url.jpg"};try{const t=await fetch(`${window.NOVA_AI_CFG.apiBase}/vision/overlay-data`,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":window.NOVA_AI_CFG.nonce},body:JSON.stringify(s)});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const d=(await t.json()).boxes||[];e.lineWidth=2,d.forEach(n=>{e.strokeStyle="lime",e.strokeRect(n.x,n.y,n.w,n.h),e.fillStyle="rgba(0,0,0,0.6)";const a=`${n.label} ${(n.conf*100).toFixed(1)}%`,c=e.measureText(a).width;e.fillRect(n.x,n.y-18,c+8,18),e.fillStyle="white",e.fillText(a,n.x+4,n.y-5)})}catch(t){console.error("Fehler beim Abrufen des Overlays:",t),alert(`Fehler beim Abrufen des Overlays: ${t instanceof Error?t.message:String(t)}`)}},g.append(r)}function p(g,o){const e=document.createElement(g);return o&&(e.className=o),e}function b(g){const o=p("div","nova-fallback");o.textContent="WebGPU nicht verfügbar. Es wird CPU/Canvas-Fallback genutzt.",g.appendChild(o)}async function G(g,o,e,r,s,t){const{device:u,filterPipeline:d,filterBindGroup:n,sampler:a}=g,c=u.createCommandEncoder(),f=c.beginRenderPass({colorAttachments:[{view:e.createView(),loadOp:"clear",storeOp:"store"}]});u.queue.writeBuffer(n.getBindingResource(2).buffer,0,new Float32Array([r,s,t,0]));const i=u.createBindGroup({layout:d.getBindGroupLayout(0),entries:[{binding:0,resource:a},{binding:1,resource:o.createView()},{binding:2,resource:{buffer:n.getBindingResource(2).buffer}}]});f.setPipeline(d),f.setBindGroup(0,i),f.draw(4),f.end(),u.queue.submit([c.finish()])}async function B(g,o,e,r,s){const{device:t,resizePipeline:u,resizeBindGroup:d}=g,n=t.createBuffer({size:o.width*o.height*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC,mappedAtCreation:!0});new Uint8Array(n.getMappedRange()).set(await t.queue.readBuffer(o,0)),n.unmap();const a=t.createBuffer({size:r*s*4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC}),c=t.createBuffer({size:4*Uint32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});t.queue.writeBuffer(c,0,new Uint32Array([o.width,o.height,r,s]));const f=t.createBindGroup({layout:u.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:n}},{binding:1,resource:{buffer:a}},{binding:2,resource:{buffer:c}}]}),i=t.createCommandEncoder(),l=i.beginComputePass();l.setPipeline(u),l.setBindGroup(0,f),l.dispatchWorkgroups(Math.ceil(r/8),Math.ceil(s/8)),l.end();const m=t.createTexture({size:[r,s],format:"rgba8unorm",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST});return i.copyBufferToTexture({buffer:a,bytesPerRow:r*4,rowsPerImage:s},{texture:m},[r,s]),t.queue.submit([i.finish()]),m}document.addEventListener("DOMContentLoaded",async()=>{const g=document.querySelectorAll(".nova-ai-gpu-root");for(const o of g){const e=p("div","nova-toolbar"),r=p("canvas","nova-canvas"),s=p("canvas","nova-overlay");s.width=r.width=1280,s.height=r.height=720,o.append(e,r,s);let t=null;if("gpu"in navigator)try{t=await P(r)}catch(T){console.error(T),t=null}t||b(o),U(e,r,s),w(e,s);const u=p("div","nova-filter-group"),d=p("input");d.type="range",d.min="-1",d.max="1",d.step="0.01",d.value="0";const n=p("input");n.type="range",n.min="0",n.max="2",n.step="0.01",n.value="1";const a=p("input");a.type="range",a.min="0",a.max="2",a.step="0.01",a.value="1";const c=p("button");c.textContent="Filter anwenden",u.append(p("label",""),d,p("label",""),n,p("label",""),a,c),e.append(u),c.onclick=async()=>{if(!t){alert("WebGPU nicht verfügbar.");return}const T=t.device.createTexture({size:[r.width,r.height],format:"rgba8unorm",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC}),h=t.device.createTexture({size:[r.width,r.height],format:"rgba8unorm",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST});await G(t,T,h,parseFloat(d.value),parseFloat(n.value),parseFloat(a.value))};const f=p("div","nova-resize-group"),i=p("input");i.type="number",i.value=String(r.width/2),i.min="1";const l=p("input");l.type="number",l.value=String(r.height/2),l.min="1";const m=p("button");m.textContent="Resize anwenden",f.append(p("label",""),i,p("label",""),l,m),e.append(f),m.onclick=async()=>{if(!t){alert("WebGPU nicht verfügbar.");return}const T=t.device.createTexture({size:[r.width,r.height],format:"rgba8unorm",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC});await B(t,T,t.device.createTexture({size:[parseInt(i.value),parseInt(l.value)],format:"rgba8unorm",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST}),parseInt(i.value),parseInt(l.value))}}});
