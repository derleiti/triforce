#!/bin/bash
# opencode-triforce - TriForce Wrapper fÃ¼r OpenCode CLI (opencode.ai)
set -e

OPENCODE_BIN=""
for path in /usr/local/bin/opencode ~/.local/bin/opencode $(which opencode 2>/dev/null); do
    [[ -x "$path" ]] && OPENCODE_BIN="$path" && break
done

[[ -z "$OPENCODE_BIN" ]] && echo "ERROR: opencode nicht gefunden. curl -fsSL https://opencode.ai/install | bash" >&2 && exit 1

WORK_DIR="${TRIFORCE_WORKDIR:-/home/zombie/ailinux-ai-server-backend}"
cd "$WORK_DIR"
export OPENCODE_CONFIG_DIR="${OPENCODE_CONFIG_DIR:-$WORK_DIR/.opencode}"

# API Keys laden
[[ -f "$WORK_DIR/.env" ]] && {
    while IFS= read -r line; do
        [[ -n "$line" ]] && export "$line"
    done < <(grep -E '^(ANTHROPIC|OPENAI|GOOGLE)_API_KEY=' "$WORK_DIR/.env" 2>/dev/null)
}

case "${1:-}" in
    "-h"|"--help"|"help") exec "$OPENCODE_BIN" --help ;;
    "-v"|"--version"|"version") exec "$OPENCODE_BIN" --version ;;
    "run") shift; [[ $# -eq 0 ]] && read -r prompt && exec "$OPENCODE_BIN" run "$prompt"; exec "$OPENCODE_BIN" run "$@" ;;
    "serve"|"server") shift; exec "$OPENCODE_BIN" serve "$@" ;;
    "attach") shift; exec "$OPENCODE_BIN" run --attach "$@" ;;
    "auth"|"login") exec "$OPENCODE_BIN" auth "$@" ;;
    "models") exec "$OPENCODE_BIN" models ;;
    "agent"|"agents") shift; exec "$OPENCODE_BIN" agent "$@" ;;
    "github"|"gh") shift; exec "$OPENCODE_BIN" github "$@" ;;
    "") exec "$OPENCODE_BIN" ;;
    *) [[ "$1" == -* ]] && exec "$OPENCODE_BIN" "$@"; exec "$OPENCODE_BIN" run "$@" ;;
esac
