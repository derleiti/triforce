#!/bin/bash
# codex-triforce - TriForce Wrapper für OpenAI Codex CLI
set -e

CODEX_BIN=""
for path in /usr/local/bin/codex ~/.npm-global/bin/codex $(which codex 2>/dev/null); do
    [[ -x "$path" ]] && CODEX_BIN="$path" && break
done

[[ -z "$CODEX_BIN" ]] && echo "ERROR: codex nicht gefunden. npm install -g @openai/codex" >&2 && exit 1

WORK_DIR="${TRIFORCE_WORKDIR:-/home/zombie/ailinux-ai-server-backend}"

# Prüfe ob --full-auto oder --cd schon in Argumenten
has_full_auto=false
has_cd=false
for arg in "$@"; do
    [[ "$arg" == "--full-auto" ]] && has_full_auto=true
    [[ "$arg" == "--cd" ]] && has_cd=true
done

# Baue zusätzliche Flags
extra_flags=""
$has_cd || extra_flags="$extra_flags --cd $WORK_DIR"
extra_flags="$extra_flags --skip-git-repo-check"

case "${1:-}" in
    # Kein Argument und kein Pipe: Interaktiv starten
    "")
        if [[ -t 0 ]]; then
            exec "$CODEX_BIN"
        else
            # Pipe-Input ohne Argumente
            exec "$CODEX_BIN" exec - $extra_flags --full-auto
        fi
        ;;
    "-h"|"--help")
        exec "$CODEX_BIN" --help
        ;;
    "exec"|"e")
        shift
        if $has_full_auto; then
            exec "$CODEX_BIN" exec "$@" $extra_flags
        else
            exec "$CODEX_BIN" exec "$@" $extra_flags --full-auto
        fi
        ;;
    "mcp-server")
        exec "$CODEX_BIN" mcp-server $extra_flags
        ;;
    *)
        # Alle anderen Befehle direkt durchreichen
        exec "$CODEX_BIN" "$@"
        ;;
esac
