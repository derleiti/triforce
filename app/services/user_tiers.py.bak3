"""
AILinux User Tier System v2.0
=============================

Tier-Struktur:
- GUEST: Ohne Anmeldung - Nur Ollama Modelle, kein MCP
- REGISTERED: Angemeldet ohne Abo - Ollama + MCP Tools
- PRO: Mit Abo - Ollama + MCP + alle Server-Modelle + 100k Token/Tag
- ENTERPRISE: Premium - Alles unlimited
"""
from enum import Enum
from typing import Optional, Dict, List
from dataclasses import dataclass
from datetime import datetime
import json
from pathlib import Path


class UserTier(str, Enum):
    GUEST = "guest"           # Ohne Anmeldung
    REGISTERED = "registered" # Angemeldet, kein Abo
    PRO = "pro"              # Mit Abo
    ENTERPRISE = "enterprise" # Premium

    # Alias für Kompatibilität
    FREE = "guest"


@dataclass
class TierConfig:
    name: str
    display_name: str
    price_monthly: float
    price_yearly: float
    models: str  # "ollama_only", "ollama_mcp", "all"
    mcp_access: bool
    cli_agents: bool
    priority_queue: bool
    support_level: str
    features: List[str]
    daily_token_limit: int = 0  # 0 = unlimited


# ============================================================================
# MODELL-LISTEN
# ============================================================================

# Ollama Modelle (immer kostenlos, laufen auf AILinux Server)
OLLAMA_MODELS = [
    # === Cloud Ollama (extern gehostet) ===
    "ollama/deepseek-v3.1:671b-cloud",
    "ollama/qwen3-coder:480b-cloud",
    "ollama/qwen3-vl:235b-cloud",
    "ollama/cogito-2.1:671b-cloud",
    "ollama/kimi-k2:1t-cloud",
    "ollama/kimi-k2-thinking:cloud",
    "ollama/gpt-oss:120b-cloud",
    "ollama/gpt-oss:20b-cloud",
    "ollama/gemini-3-pro-preview:latest",
    "ollama/minimax-m2:cloud",
    "ollama/glm-4.6:cloud",
    "ollama/ministral-3:14b-cloud",
    
    # === Lokale Ollama Modelle ===
    "ollama/llama3.2:latest",
    "ollama/llama3.2:3b",
    "ollama/qwen2.5:7b",
    "ollama/qwen2.5:14b",
    "ollama/qwen2.5:32b",
    "ollama/qwen2.5-coder:7b",
    "ollama/qwen2.5-coder:14b",
    "ollama/mistral:7b",
    "ollama/mistral:latest",
    "ollama/codellama:7b",
    "ollama/codellama:13b",
    "ollama/deepseek-coder:6.7b",
    "ollama/deepseek-r1:8b",
    "ollama/phi3:mini",
    "ollama/gemma2:9b",
]

# Kostenlose Cloud-APIs
FREE_CLOUD_MODELS = [
    # === Groq ===
    "groq/llama-3.3-70b-versatile",
    "groq/qwen/qwen3-32b",
    "groq/meta-llama/llama-4-scout-17b-16e-instruct",
    "groq/openai/gpt-oss-120b",
    # === Cerebras ===
    "cerebras/llama-3.3-70b",
    "cerebras/qwen-3-32b",
    # === Cloudflare ===
    "cloudflare/@cf/meta/llama-3.3-70b-instruct-fp8-fast",
    "cloudflare/@cf/qwen/qwen2.5-coder-32b-instruct",
    # === Gemini Free ===
    "gemini/gemini-2.0-flash-lite",
    "gemini/gemini-2.0-flash",
]

# Premium Modelle (OpenRouter)
PREMIUM_MODELS = [
    # === Claude ===
    "openrouter/anthropic/claude-opus-4.5",
    "openrouter/anthropic/claude-sonnet-4.5",
    "openrouter/anthropic/claude-opus-4",
    "openrouter/anthropic/claude-sonnet-4",
    "openrouter/anthropic/claude-3.5-sonnet",
    # === OpenAI ===
    "openrouter/openai/gpt-5",
    "openrouter/openai/gpt-5-pro",
    "openrouter/openai/o3",
    "openrouter/openai/gpt-4o",
    # === Grok ===
    "openrouter/x-ai/grok-4",
    "openrouter/x-ai/grok-3",
    # === Google ===
    "openrouter/google/gemini-2.5-pro",
    "openrouter/google/gemini-2.5-flash",
    # === DeepSeek ===
    "openrouter/deepseek/deepseek-r1",
    "openrouter/deepseek/deepseek-chat",
    # === Qwen ===
    "openrouter/qwen/qwen3-235b-a22b",
    "openrouter/qwen/qwen3-coder",
    # === Mistral ===
    "openrouter/mistralai/mistral-large-2512",
]

# Alias für Kompatibilität
FREE_MODELS_OLLAMA = OLLAMA_MODELS
FREE_MODELS = OLLAMA_MODELS  # Alias für Kompatibilität
ALL_OPENROUTER_MODELS = OLLAMA_MODELS + FREE_CLOUD_MODELS + PREMIUM_MODELS


# ============================================================================
# TIER-KONFIGURATION
# ============================================================================

TIER_CONFIGS: Dict[UserTier, TierConfig] = {
    UserTier.GUEST: TierConfig(
        name="guest",
        display_name="Gast",
        price_monthly=0.0,
        price_yearly=0.0,
        models="ollama_only",
        mcp_access=False,
        cli_agents=False,
        priority_queue=False,
        support_level="none",
        daily_token_limit=50_000,
        features=[
            "Kostenlos ohne Anmeldung",
            "Ollama Modelle (lokal)",
            "Chat-Funktion",
            "50k Tokens/Tag",
        ]
    ),
    UserTier.REGISTERED: TierConfig(
        name="registered",
        display_name="Registriert",
        price_monthly=0.0,
        price_yearly=0.0,
        models="ollama_mcp",
        mcp_access=True,
        cli_agents=True,
        priority_queue=False,
        support_level="community",
        daily_token_limit=100_000,
        features=[
            "Kostenlos mit Anmeldung",
            "Ollama + Free Cloud Modelle",
            "MCP Tools Zugriff",
            "CLI Agents",
            "100k Tokens/Tag",
        ]
    ),
    UserTier.PRO: TierConfig(
        name="pro",
        display_name="Pro",
        price_monthly=14.99,
        price_yearly=149.99,
        models="all",
        mcp_access=True,
        cli_agents=True,
        priority_queue=False,
        support_level="email",
        daily_token_limit=100_000,
        features=[
            "Alle Registriert Features",
            "500+ Premium Modelle",
            "Ollama immer kostenlos",
            "100k Tokens/Tag",
            "Email Support",
        ]
    ),
    UserTier.ENTERPRISE: TierConfig(
        name="enterprise",
        display_name="Enterprise",
        price_monthly=49.99,
        price_yearly=499.99,
        models="all",
        mcp_access=True,
        cli_agents=True,
        priority_queue=True,
        support_level="24/7",
        daily_token_limit=0,
        features=[
            "Alle Pro Features",
            "Unbegrenzte Tokens",
            "Priority Queue",
            "24/7 Support",
            "API Access",
        ]
    ),
}


class UserTierService:
    """Service für User-Tier-Management"""
    
    def __init__(self, users_path: Path = None):
        possible_paths = [
            Path(".vault/users"),
            Path("/opt/triforce/.vault/users"),
            Path("/home/zombie/triforce/.vault/users"),
        ]
        
        self.users_path = users_path
        if not self.users_path:
            for p in possible_paths:
                if p.parent.exists():
                    self.users_path = p
                    break
            else:
                self.users_path = Path(".vault/users")
        
        self.users_path.mkdir(parents=True, exist_ok=True)
        self._token_usage: Dict[str, Dict] = {}
    
    def get_user_tier(self, user_id: str = None) -> UserTier:
        """Hole Tier eines Users (None = Guest)"""
        if not user_id:
            return UserTier.GUEST
        
        user_file = self.users_path / f"{user_id}.json"
        
        if not user_file.exists():
            return UserTier.REGISTERED
        
        try:
            data = json.loads(user_file.read_text())
            tier_str = data.get("tier", "registered")
            if tier_str == "free":
                tier_str = "registered"
            return UserTier(tier_str)
        except:
            return UserTier.REGISTERED
    
    def set_user_tier(self, user_id: str, tier: UserTier, expires: datetime = None) -> bool:
        """Setze Tier für einen User"""
        user_file = self.users_path / f"{user_id}.json"
        
        try:
            if user_file.exists():
                data = json.loads(user_file.read_text())
            else:
                data = {"user_id": user_id, "created": datetime.now().isoformat()}
            
            data["tier"] = tier.value
            data["tier_updated"] = datetime.now().isoformat()
            if expires:
                data["tier_expires"] = expires.isoformat()
            
            user_file.write_text(json.dumps(data, indent=2))
            return True
        except Exception as e:
            print(f"Error setting tier: {e}")
            return False
    
    def get_allowed_models(self, user_id: str = None) -> List[str]:
        """Hole erlaubte Modelle für einen User"""
        tier = self.get_user_tier(user_id)
        config = TIER_CONFIGS[tier]

        if config.models == "ollama_only":
            return OLLAMA_MODELS
        elif config.models == "ollama_mcp":
            return OLLAMA_MODELS + FREE_CLOUD_MODELS
        else:
            return ALL_OPENROUTER_MODELS
    
    def get_model_backend(self, user_id: str = None) -> str:
        """Hole das Backend für einen User"""
        tier = self.get_user_tier(user_id)
        config = TIER_CONFIGS[tier]
        
        if config.models == "ollama_only":
            return "ollama"
        elif config.models == "ollama_mcp":
            return "mixed"
        else:
            return "openrouter"
    
    def has_mcp_access(self, user_id: str = None) -> bool:
        """Prüfe ob User MCP-Zugriff hat"""
        tier = self.get_user_tier(user_id)
        return TIER_CONFIGS[tier].mcp_access
    
    def has_cli_agents(self, user_id: str = None) -> bool:
        """Prüfe ob User CLI Agents nutzen kann"""
        tier = self.get_user_tier(user_id)
        return TIER_CONFIGS[tier].cli_agents
    
    def is_model_allowed(self, user_id: str, model: str) -> bool:
        """Prüfe ob ein Modell für den User erlaubt ist"""
        allowed = self.get_allowed_models(user_id)
        if model in allowed:
            return True
        for m in allowed:
            if model == m.split("/")[-1] or m.endswith(model):
                return True
        return False
    
    def get_daily_token_limit(self, user_id: str = None) -> int:
        """Hole tägliches Token-Limit (0 = unlimited)"""
        tier = self.get_user_tier(user_id)
        return TIER_CONFIGS[tier].daily_token_limit
    
    def track_tokens(self, user_id: str, tokens: int) -> Dict:
        """Tracke Token-Verbrauch"""
        today = datetime.now().strftime("%Y-%m-%d")
        
        if user_id not in self._token_usage:
            self._token_usage[user_id] = {}
        if today not in self._token_usage[user_id]:
            self._token_usage[user_id][today] = 0
        
        self._token_usage[user_id][today] += tokens
        
        limit = self.get_daily_token_limit(user_id)
        used = self._token_usage[user_id][today]
        
        return {
            "used_today": used,
            "limit": limit,
            "remaining": max(0, limit - used) if limit > 0 else -1,
            "unlimited": limit == 0
        }
    
    def check_token_limit(self, user_id: str = None) -> Dict:
        """Prüfe ob Token-Limit erreicht"""
        limit = self.get_daily_token_limit(user_id)
        if limit == 0:
            return {"allowed": True, "unlimited": True}
        
        today = datetime.now().strftime("%Y-%m-%d")
        used = self._token_usage.get(user_id, {}).get(today, 0)
        
        return {
            "allowed": used < limit,
            "used": used,
            "limit": limit,
            "remaining": max(0, limit - used),
            "unlimited": False
        }
    
    def get_tier_info(self, tier: UserTier) -> Dict:
        """Hole Tier-Informationen"""
        config = TIER_CONFIGS[tier]
        
        if config.models == "ollama_only":
            model_count = len(OLLAMA_MODELS)
        elif config.models == "ollama_mcp":
            model_count = len(OLLAMA_MODELS) + len(FREE_CLOUD_MODELS)
        else:
            model_count = len(ALL_OPENROUTER_MODELS)

        return {
            "tier": tier.value,
            "name": config.display_name,
            "price_monthly": config.price_monthly,
            "price_yearly": config.price_yearly,
            "features": config.features,
            "model_count": model_count,
            "mcp_access": config.mcp_access,
            "cli_agents": config.cli_agents,
            "priority_queue": config.priority_queue,
            "daily_token_limit": config.daily_token_limit,
        }
    
    def get_all_tiers(self) -> List[Dict]:
        """Hole alle Tier-Informationen"""
        return [self.get_tier_info(tier) for tier in UserTier if tier.value != "guest"]


# Singleton
tier_service = UserTierService()
