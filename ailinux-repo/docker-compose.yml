services:
  apt-mirror:
    # HIER IST DER TURBO:
    # Wir nutzen das Host-Netzwerk NUR für den Downloader.
    # Das beschleunigt apt-mirror, hat aber KEINEN Einfluss auf Nginx.
    network_mode: host
    
    build:
      context: .
      dockerfile: ./Dockerfile
    container_name: apt-mirror
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      # Die Daten landen auf der SSD...
      - ./repo:/var/spool/apt-mirror
      - ./postmirror.sh:/var/spool/apt-mirror/var/postmirror.sh:ro
      - ./sign-repos.sh:/var/spool/apt-mirror/var/sign-repos.sh:ro
      - ./repair-dep11.sh:/var/spool/apt-mirror/var/repair-dep11.sh:ro
      - ./etc/gnupg:/var/spool/apt-mirror/etc/gnupg:rw
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'cron -f' >/dev/null"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s

  nginx:
    # Nginx lassen wir wie er ist (Bridge Mode).
    # Das ist sicher und stabil für deine User.
    image: nginx:stable
    container_name: apt-mirror-nginx
    restart: unless-stopped
    depends_on:
      apt-mirror:
        condition: service_started
    env_file:
      - .env
    ports:
      - "8080:8080"
      - "8443:8443"
      - "9000:9000"
      - "8881:8881"
      - "8882:8882"
    volumes:
      # ... und Nginx liest sie von der SSD.
      # Da beide das gleiche Verzeichnis mounten, klappt das perfekt.
      - ./repo:/repo:ro
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./conf.d:/etc/nginx/conf.d:ro
      - ./etc/ssl/cloudflare:/etc/ssl/cloudflare:ro
      - ./etc/nginx/html:/etc/nginx/html:ro
      - /etc/letsencrypt/live/ailinux.me:/etc/letsencrypt/live/ailinux.me:ro
      - /etc/letsencrypt/archive/ailinux.me:/etc/letsencrypt/archive/ailinux.me:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD-SHELL", "nginx -t && curl -fsS http://localhost:8080/ >/dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s
