services:
  apache:
    image: ${APACHE_IMAGE:-httpd:2.4-alpine}
    container_name: wordpress_apache
    depends_on:
      wordpress_fpm:
        condition: service_started
    ports:
      - "${PORT_HTTP:-80}:80"
      - "${PORT_HTTPS:-443}:443"
    volumes:
      # Apache Konfigurationen
      - ./apache/httpd.conf:/usr/local/apache2/conf/httpd.conf:ro
      - ./apache/extra:/usr/local/apache2/conf/extra:ro
      - ./apache/snippets:/usr/local/apache2/conf/snippets:ro
      - ./apache/vhosts:/usr/local/apache2/conf/vhosts:ro
      - ./apache/cloudflare-allowlist.conf:/usr/local/apache2/conf/cloudflare-allowlist.conf:ro
      # Webroot (PHP-FPM liefert aus /var/www/html)
      - ./html:/var/www/html
      # Zertifikate (Read-Only)
      - /etc/letsencrypt:/etc/letsencrypt:ro
    environment:
      TZ: ${TZ:-Europe/Berlin}
    healthcheck:
      test: ["CMD", "httpd", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - wordpress_network
      - flarum_network
    restart: unless-stopped

  wordpress_fpm:
    image: ${WORDPRESS_IMAGE:-wordpress:6.8.1-php8.3-fpm-alpine}
    container_name: wordpress_fpm
    depends_on:
      wordpress_db:
        condition: service_healthy
      wordpress_redis:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
      - "ailinux.me:172.19.0.6"  # Resolve to Apache container for loopback requests
      - "www.ailinux.me:172.19.0.6"
    environment:
      TZ: ${TZ:-Europe/Berlin}

      # DB-Verbindung
      WORDPRESS_DB_HOST: ${WORDPRESS_DB_HOST:-wordpress_db}
      WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME:-wordpress}
      WORDPRESS_DB_USER: ${WORDPRESS_DB_USER:-wordpress}
      WORDPRESS_DB_PASSWORD: ${WORDPRESS_DB_PASSWORD:?set in .env}

      # Optionales Redis-Passwort (leer = keine Auth)
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}

      WORDPRESS_REDIS_HOST: wordpress_redis
      WORDPRESS_REDIS_PORT: 6379

      # Zusätzliche WP-Konstanten (PHP-Variablen via $$ escapen!)
      WORDPRESS_CONFIG_EXTRA: |
        if (!defined('WP_REDIS_HOST')) {
          define('WP_REDIS_HOST', getenv('WORDPRESS_REDIS_HOST') ?: 'wordpress_redis');
        }
        if (!defined('WP_REDIS_PORT')) {
          $$port = getenv('WORDPRESS_REDIS_PORT');
          define('WP_REDIS_PORT', $$port !== false ? (int) $$port : 6379);
        }
        $$redisPassword = getenv('REDIS_PASSWORD');
        if ($$redisPassword !== false && trim($$redisPassword) !== '' && !defined('WP_REDIS_PASSWORD')) {
          define('WP_REDIS_PASSWORD', $$redisPassword);
        }
    volumes:
      - ./html:/var/www/html
      - ./php/custom.ini:/usr/local/etc/php/conf.d/custom.ini
      - ./php/www.conf:/usr/local/etc/php-fpm.d/www.conf
    healthcheck:
      test: ["CMD-SHELL", "pidof php-fpm >/dev/null 2>&1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - wordpress_network
    restart: unless-stopped

  wordpress_db:
    image: ${MARIADB_IMAGE:-mariadb:11}
    container_name: wordpress_db
    environment:
      TZ: ${TZ:-Europe/Berlin}
      MYSQL_DATABASE: ${WORDPRESS_DB_NAME:-wordpress}
      MYSQL_USER: ${WORDPRESS_DB_USER:-wordpress}
      MYSQL_PASSWORD: ${WORDPRESS_DB_PASSWORD:?set in .env}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:?set in .env}
    volumes:
      - db_data:/var/lib/mysql
      - ./mysql/custom.cnf:/etc/mysql/conf.d/custom.cnf
    healthcheck:
      test: ["CMD-SHELL", "MYSQL_PWD=\"$MYSQL_ROOT_PASSWORD\" mariadb-admin ping -h 127.0.0.1 -uroot --silent"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s
    networks:
      - wordpress_network
    restart: unless-stopped

  wordpress_redis:
    image: ${REDIS_IMAGE:-redis:alpine}
    container_name: wordpress_redis
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
    # Falls REDIS_PASSWORD gesetzt ist → Redis mit requirepass starten
    command: ["sh", "-lc", "if [ -n \"$REDIS_PASSWORD\" ]; then exec redis-server --requirepass \"$REDIS_PASSWORD\"; else exec redis-server; fi"]
    healthcheck:
      test: ["CMD-SHELL", "if [ -n \"$REDIS_PASSWORD\" ]; then redis-cli -a \"$REDIS_PASSWORD\" ping; else redis-cli ping; fi"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - wordpress_network
    restart: unless-stopped

  wordpress_backup:
    image: mariadb:11
    container_name: wordpress_backup
    entrypoint: ["/bin/sh", "/run-backup.sh"]
    environment:
      TZ: ${TZ:-Europe/Berlin}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:?set in .env}
      WORDPRESS_DB_HOST: ${WORDPRESS_DB_HOST:-wordpress_db}
      WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME:-wordpress}
      WORDPRESS_DB_USER: ${WORDPRESS_DB_USER:-wordpress}
      WORDPRESS_DB_PASSWORD: ${WORDPRESS_DB_PASSWORD:?set in .env}
    volumes:
      - ./backups:/backup
      - ./backups/run-backup.sh:/run-backup.sh:ro
    depends_on:
      wordpress_db:
        condition: service_healthy
    networks:
      - wordpress_network
    restart: unless-stopped

  wpcli:
    image: ${WPCLI_IMAGE:-wordpress:cli}
    container_name: wordpress_wpcli
    depends_on:
      wordpress_fpm:
        condition: service_healthy
      wordpress_db:
        condition: service_healthy
    working_dir: /var/www/html
    user: "33:33"   # www-data
    environment:
      TZ: ${TZ:-Europe/Berlin}
      WORDPRESS_DB_HOST: ${WORDPRESS_DB_HOST:-wordpress_db}
      WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME:-wordpress}
      WORDPRESS_DB_USER: ${WORDPRESS_DB_USER:-wordpress}
      WORDPRESS_DB_PASSWORD: ${WORDPRESS_DB_PASSWORD:?set in .env}
    volumes:
      - ./html:/var/www/html
    entrypoint: ["bash", "-lc"]
    command: "wp --info && bash"
    networks:
      - wordpress_network

  wordpress_cron:
    image: ${WPCLI_IMAGE:-wordpress:cli}
    container_name: wordpress_cron
    depends_on:
      wordpress_fpm:
        condition: service_healthy
      wordpress_db:
        condition: service_healthy
    working_dir: /var/www/html
    environment:
      TZ: ${TZ:-Europe/Berlin}
      WORDPRESS_DB_HOST: ${WORDPRESS_DB_HOST:-wordpress_db}
      WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME:-wordpress}
      WORDPRESS_DB_USER: ${WORDPRESS_DB_USER:-wordpress}
      WORDPRESS_DB_PASSWORD: ${WORDPRESS_DB_PASSWORD:?set in .env}
    volumes:
      - ./html:/var/www/html
      - ./cron-runner.sh:/cron-runner.sh:ro
    entrypoint: ["/bin/sh", "/cron-runner.sh"]
    networks:
      - wordpress_network
    restart: unless-stopped

networks:
  wordpress_network:
    name: wordpress_wordpress_network
    external: true
  flarum_network:
    name: flarum_network
    external: true

volumes:
  db_data:
