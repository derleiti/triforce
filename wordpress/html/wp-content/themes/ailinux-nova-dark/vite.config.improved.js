import { defineConfig } from 'vite';
import { resolve } from 'path';
import fs from 'fs';

/**
 * Vite Plugin: Manifest Generator for WordPress
 * Generates a PHP-compatible manifest for cache-busted asset loading
 */
function wordpressManifestPlugin() {
  return {
    name: 'wordpress-manifest',
    apply: 'build',
    writeBundle(options, bundle) {
      const manifest = {};

      // Generate manifest mapping original names to built files
      for (const [fileName, chunk] of Object.entries(bundle)) {
        if (chunk.type === 'chunk' || chunk.type === 'asset') {
          // Extract entry name from fileName
          const baseName = fileName.replace(/\.[^.]+$/, ''); // Remove extension
          manifest[baseName] = {
            file: fileName,
            type: chunk.type === 'chunk' ? 'js' : 'css',
            src: chunk.type === 'chunk' ? chunk.facadeModuleId : undefined
          };
        }
      }

      // Write manifest.json for JavaScript consumption
      const manifestPath = resolve(options.dir, 'manifest.json');
      fs.writeFileSync(manifestPath, JSON.stringify(manifest, null, 2));

      // Write manifest.php for WordPress
      const phpManifest = `<?php
/**
 * Auto-generated asset manifest
 * Generated at: ${new Date().toISOString()}
 * Do not edit this file manually
 */

if (!defined('ABSPATH')) {
    exit;
}

return ${JSON.stringify(manifest, null, 4)};
`;
      const phpManifestPath = resolve(options.dir, 'manifest.php');
      fs.writeFileSync(phpManifestPath, phpManifest);

      console.log('âœ… WordPress manifest generated:', phpManifestPath);
    }
  };
}

export default defineConfig({
  root: __dirname,
  publicDir: false,
  build: {
    outDir: 'dist',
    assetsDir: '.',
    emptyOutDir: false,
    cssCodeSplit: false,
    sourcemap: process.env.NODE_ENV === 'development',
    minify: 'esbuild',
    rollupOptions: {
      input: {
        app: resolve(__dirname, 'assets/js/app.js'),
        colorMode: resolve(__dirname, 'assets/js/color-mode.js'),
        customizer: resolve(__dirname, 'assets/js/customizer.js'),
        'mobile-menu': resolve(__dirname, 'assets/js/mobile-menu.js'),
        webgpu: resolve(__dirname, 'assets/js/webgpu.js'),
        style: resolve(__dirname, 'assets/scss/style.scss')
      },
      output: {
        // Use content hashing for cache busting
        entryFileNames: '[name].[hash].js',
        chunkFileNames: '[name].[hash].js',
        assetFileNames: (assetInfo) => {
          // Keep style.css name predictable for WordPress
          if (assetInfo.name === 'style.css') {
            return 'style.[hash].css';
          }
          return '[name].[hash][extname]';
        }
      }
    }
  },
  css: {
    preprocessorOptions: {
      scss: {
        additionalData: '',
        includePaths: [resolve(__dirname, 'assets/scss')]
      }
    }
  },
  plugins: [wordpressManifestPlugin()]
});
