# --- HTTP :80 -> HTTPS Redirect ---
<VirtualHost *:80>
  ServerName ailinux.me
  ServerAlias www.ailinux.me
  RewriteEngine On
  RewriteRule ^/(.*)$ https://ailinux.me/$1 [R=301,L]

  Header always set X-Content-Type-Options "nosniff"
</VirtualHost>

# --- HTTPS :443 Ã¶ffentlich ---
<VirtualHost *:443>
  ServerName ailinux.me
  ServerAlias www.ailinux.me

  RewriteEngine On
  RewriteCond %{HTTP_HOST} !^ailinux\.me$ [NC]
  RewriteRule ^/(.*)$ https://ailinux.me/$1 [R=301,L]

  SSLEngine on
  SSLCertificateFile      /etc/letsencrypt/live/ailinux.me/fullchain.pem
  SSLCertificateKeyFile   /etc/letsencrypt/live/ailinux.me/privkey.pem

  IncludeOptional conf.d/snippets/ssl-params.conf

  DocumentRoot "/var/www/html"
  <Directory "/var/www/html">
    AllowOverride All
    Require all granted
  </Directory>

  <FilesMatch \.php$>
    SetHandler "proxy:fcgi://wordpress_fpm:9000"
  </FilesMatch>

  DirectoryIndex index.php index.html

  # Security Headers
  Header always set X-Content-Type-Options "nosniff"
  Header always set X-Frame-Options "SAMEORIGIN"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"

  # Content Security Policy - Pragmatic & Functional
  # NOTE: This is the ONLY place where CSP is set. Do NOT enable CSP in WordPress plugins.
  Header always set Content-Security-Policy-Report-Only "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' blob: https://www.googletagmanager.com https://www.gstatic.com https://pagead2.googlesyndication.com https://tpc.googlesyndication.com https://www.googletagservices.com https://widget.intercom.io https://cdn.gtranslate.net https://translate.google.com https://translate.googleapis.com https://challenges.cloudflare.com https://translate-pa.googleapis.com https://js.intercomcdn.com https://www.youtube.com https://static.addtoany.com https://fundingchoicesmessages.google.com https://ep2.adtrafficquality.google; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; font-src 'self' data: https:; connect-src 'self' https://api.ailinux.me https://api.ailinux.me:9000 https://api.ailinux.me:9100 https:; frame-src *; worker-src 'self' blob:; media-src 'self' data: https:; object-src 'none'; base-uri 'self'; form-action 'self'; report-uri /csp-report.php;"

  Protocols h2 http/1.1
  SSLVerifyClient none
</VirtualHost>
