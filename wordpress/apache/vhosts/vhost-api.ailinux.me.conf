# --- HTTP :80 -> HTTPS Redirect ---
<VirtualHost *:80>
  ServerName api.ailinux.me
  RewriteEngine On
  RewriteRule ^/(.*)$ https://api.ailinux.me/$1 [R=301,L]

  Header always set X-Content-Type-Options "nosniff"
</VirtualHost>

# --- HTTPS :443 API Reverse Proxy ---
<VirtualHost *:443>
  ServerName api.ailinux.me

  SSLEngine on
  SSLCertificateFile      /etc/letsencrypt/live/ailinux.me/fullchain.pem
  SSLCertificateKeyFile   /etc/letsencrypt/live/ailinux.me/privkey.pem

  IncludeOptional conf.d/snippets/ssl-params.conf

  # Reverse Proxy to FastAPI Backend (running on host)
  ProxyPreserveHost On

  # SSE/Streaming Support - CRITICAL for MCP
  SetEnv proxy-sendchunked 1
  SetEnv proxy-sendcl 0
  SetEnv proxy-initial-not-pooled 1

  # Long timeout for SSE/MCP connections
  ProxyTimeout 86400

  # MCP Endpoint with SSE support
  <Location /mcp>
    ProxyPass http://172.19.0.1:9100/mcp
    ProxyPassReverse http://172.19.0.1:9100/mcp

    # Disable buffering for SSE
    SetEnv proxy-sendchunked 1
    SetEnv proxy-nokeepalive 1
  </Location>

  # Default proxy for all other endpoints
  ProxyPass / http://172.19.0.1:9100/
  ProxyPassReverse / http://172.19.0.1:9100/

  # WebSocket Support (if needed)
  RewriteEngine On
  RewriteCond %{HTTP:Upgrade} =websocket [NC]
  RewriteRule /(.*)           ws://172.19.0.1:9100/$1 [P,L]

  # Security Headers
  Header always set X-Content-Type-Options "nosniff"
  Header always set X-Frame-Options "SAMEORIGIN"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"

  # CORS Headers (allow all origins for API) - MCP support added
  Header always set Access-Control-Allow-Origin "*"
  Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH"
  Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-AILinux-Client, X-Requested-With, Accept, mcp-session-id"
  Header always set Access-Control-Expose-Headers "mcp-session-id"
  Header always set Access-Control-Max-Age "86400"

  # Handle preflight OPTIONS requests - respond immediately without proxying
  RewriteCond %{REQUEST_METHOD} OPTIONS
  RewriteRule ^(.*)$ $1 [R=204,L]

  Protocols h2 http/1.1
  SSLVerifyClient none

  # Logging
  ErrorLog  "/proc/self/fd/2"
  CustomLog "/proc/self/fd/1" realip
</VirtualHost>
