#!/bin/bash
set -e

# Farben
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

INSTALL_DIR="${HOME}/project-triforce"
ENV_FILE="${INSTALL_DIR}/config/triforce.env"

echo -e "${GREEN}üî± TriForce Setup v4.1.0 - Post-Installation${NC}"

# Phase 1: Verzeichnisse
echo "[1/5] Erstelle Verzeichnisse..."
mkdir -p "${INSTALL_DIR}"/{config,logs,data,auth}
mkdir -p "${HOME}/.config/triforce"

# Phase 2: Dateien verschieben (falls aus /usr/share installiert)
if [ -d "/usr/share/triforce" ]; then
    cp -rn /usr/share/triforce/* "${INSTALL_DIR}/" 2>/dev/null || true
fi

# Phase 3: Secrets generieren falls leer
echo "[2/5] Generiere fehlende Secrets..."
generate_secret() {
    openssl rand -base64 32 2>/dev/null || head -c 32 /dev/urandom | base64
}

if [ -f "$ENV_FILE" ]; then
    # MYSQL_ROOT_PASSWORD
    if grep -q "^MYSQL_ROOT_PASSWORD=$" "$ENV_FILE"; then
        SECRET=$(generate_secret)
        sed -i "s/^MYSQL_ROOT_PASSWORD=$/MYSQL_ROOT_PASSWORD=${SECRET}/" "$ENV_FILE"
        echo "   ‚úì MYSQL_ROOT_PASSWORD generiert"
    fi
    
    # WORDPRESS_DB_PASSWORD
    if grep -q "^WORDPRESS_DB_PASSWORD=$" "$ENV_FILE"; then
        SECRET=$(generate_secret)
        sed -i "s/^WORDPRESS_DB_PASSWORD=$/WORDPRESS_DB_PASSWORD=${SECRET}/" "$ENV_FILE"
        echo "   ‚úì WORDPRESS_DB_PASSWORD generiert"
    fi
    
    # SEARXNG_SECRET_KEY
    if grep -q "^SEARXNG_SECRET_KEY=$" "$ENV_FILE"; then
        SECRET=$(generate_secret)
        sed -i "s/^SEARXNG_SECRET_KEY=$/SEARXNG_SECRET_KEY=${SECRET}/" "$ENV_FILE"
        echo "   ‚úì SEARXNG_SECRET_KEY generiert"
    fi
fi

# Phase 4: Wrapper Scripts
echo "[3/5] Installiere CLI Wrapper..."
if [ -d "${INSTALL_DIR}/scripts/wrappers" ]; then
    for script in "${INSTALL_DIR}/scripts/wrappers"/*; do
        if [ -f "$script" ]; then
            sudo cp "$script" /usr/local/bin/ 2>/dev/null || cp "$script" "${HOME}/.local/bin/"
            sudo chmod +x "/usr/local/bin/$(basename $script)" 2>/dev/null || true
        fi
    done
fi

# Phase 5: Python Dependencies
echo "[4/5] Installiere Python Dependencies..."
pip3 install --quiet --break-system-packages fastapi uvicorn pydantic 2>/dev/null || \
pip3 install --quiet fastapi uvicorn pydantic 2>/dev/null || true

# Phase 6: Symlink .env
echo "[5/5] Erstelle Symlinks..."
ln -sf "${INSTALL_DIR}/config/triforce.env" "${INSTALL_DIR}/.env" 2>/dev/null || true

echo ""
echo -e "${GREEN}‚úÖ Installation abgeschlossen!${NC}"
echo ""
echo "N√§chste Schritte:"
echo "  1. cd ${INSTALL_DIR}"
echo "  2. python3 app/setup_service.py"
echo "  3. Browser √∂ffnen: http://localhost:9100"
echo ""
echo -e "${YELLOW}üêª Brumo sagt: 'Jetzt noch Docker starten und l√§uft.'${NC}"

exit 0
