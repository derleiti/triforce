# --- HTTP :80 -> HTTPS Redirect ---
<VirtualHost *:80>
  ServerName search.ailinux.me
  RewriteEngine On
  RewriteRule ^/(.*)$ https://search.ailinux.me/$1 [R=301,L]
  Header always set X-Content-Type-Options "nosniff"
  <FilesMatch "\.html$">
    Header set Cache-Control "no-cache, no-store, must-revalidate"
    Header set Pragma "no-cache"
    Header set Expires "0"
  </FilesMatch>
  # Internal API Proxy - direkt zu localhost:9000 (kein Auth)
  <Location /api>
    ProxyPass http://host.docker.internal:9000/v1/mcp
    ProxyPassReverse http://host.docker.internal:9000/v1/mcp
    SetEnv proxy-sendchunked 1
  </Location>

</VirtualHost>

# --- HTTPS :443 MeshAI Search Frontend ---
<VirtualHost *:443>
  ServerName search.ailinux.me

  SSLEngine on
  SSLCertificateFile      /etc/letsencrypt/live/ailinux.me/fullchain.pem
  SSLCertificateKeyFile   /etc/letsencrypt/live/ailinux.me/privkey.pem

  IncludeOptional conf.d/snippets/ssl-params.conf

  # MeshAI Search Static Files
  DocumentRoot /var/www/search-root
  <Directory /var/www/search-root>
    Options -Indexes +FollowSymLinks
    AllowOverride None
    Require all granted
  </Directory>

  RewriteEngine On

  # /search?q=... an SearXNG weiterleiten
  RewriteCond %{QUERY_STRING} ^q=(.+)$
  RewriteRule ^/search$ http://172.17.0.1:8888/search?q=%1 [P,L]

  # /{suchbegriff} an MeshAI Search mit Query weiterleiten
  RewriteCond %{REQUEST_URI} !^/searxng
  RewriteCond %{REQUEST_URI} !^/search
  RewriteCond %{REQUEST_URI} !^/api
  RewriteCond %{REQUEST_URI} !\.
  RewriteCond %{REQUEST_URI} ^/(.+)$
  RewriteRule ^/(.+)$ /?q=%1 [R=302,L]

  # === FIX: Proxy Header f√ºr SearXNG Bot-Detection ===
  ProxyPreserveHost On
  RequestHeader set X-Forwarded-Proto "https"
  RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"
  RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}s"
  
  # SearXNG Backend unter /searxng
  ProxyPass /searxng http://172.17.0.1:8888/
  ProxyPassReverse /searxng http://172.17.0.1:8888/

  # === INTERNAL API PROXY (VIP - no auth required) ===
  # Routes /api/* to backend WITHOUT X-Forwarded-Port header
  # This allows search frontend to access MCP without authentication
  ProxyPass /api http://host.docker.internal:9000/v1
  ProxyPassReverse /api http://host.docker.internal:9000/v1

  # Security Headers
  Header always set X-Content-Type-Options "nosniff"
  Header always set X-Frame-Options "SAMEORIGIN"
  Header always set X-XSS-Protection "1; mode=block"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"

  # CORS
  Header always set Access-Control-Allow-Origin "*"
  Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
  Header always set Access-Control-Allow-Headers "Content-Type, Authorization"

  Protocols h2 http/1.1

  ErrorLog  "/proc/self/fd/2"
  CustomLog "/proc/self/fd/1" realip
  
  <FilesMatch "\.html$">
    Header set Cache-Control "no-cache, no-store, must-revalidate"
    Header set Pragma "no-cache"
    Header set Expires "0"
  </FilesMatch>
  # Internal API Proxy - direkt zu localhost:9000 (kein Auth)
  <Location /api>
    ProxyPass http://host.docker.internal:9000/v1/mcp
    ProxyPassReverse http://host.docker.internal:9000/v1/mcp
    SetEnv proxy-sendchunked 1
  </Location>

</VirtualHost>
