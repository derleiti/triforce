# ============================================================================
# API VHost für api.ailinux.me
# Backend: host.docker.internal:9000 (FastAPI/Uvicorn auf Host)
#
# Security Headers: Mozilla Observatory A+ Target
# Updated: 2024-12-22
# ============================================================================

# --- HTTP :80 -> HTTPS Redirect ---
<VirtualHost *:80>
  ServerName api.ailinux.me
  RewriteEngine On
  RewriteRule ^/(.*)$ https://api.ailinux.me/$1 [R=301,L]
</VirtualHost>

# --- HTTPS :443 API Reverse Proxy ---
<VirtualHost *:443>
  ServerName api.ailinux.me

  SSLEngine on
  SSLCertificateFile      /etc/letsencrypt/live/ailinux.me/fullchain.pem
  SSLCertificateKeyFile   /etc/letsencrypt/live/ailinux.me/privkey.pem
  IncludeOptional conf.d/snippets/ssl-params.conf

  # === STATISCHE INDEX-SEITE ===
  DocumentRoot /var/www/api-root
  <Directory /var/www/api-root>
    Options -Indexes +FollowSymLinks
    AllowOverride None
    Require all granted
  </Directory>

  # Reverse Proxy Settings
  ProxyPreserveHost On
  RequestHeader set X-Forwarded-Port "9100"
  ProxyTimeout 86400

  # SSE/Streaming Support
  SetEnv proxy-sendchunked 1
  SetEnv proxy-sendcl 0
  SetEnv proxy-initial-not-pooled 1

  # === OAUTH 2.0 ENDPOINTS ===
  ProxyPass /.well-known http://host.docker.internal:9000/.well-known
  ProxyPassReverse /.well-known http://host.docker.internal:9000/.well-known

  ProxyPass /authorize http://host.docker.internal:9000/authorize
  ProxyPassReverse /authorize http://host.docker.internal:9000/authorize

  ProxyPass /token http://host.docker.internal:9000/token
  ProxyPassReverse /token http://host.docker.internal:9000/token

  ProxyPass /auth http://host.docker.internal:9000/auth
  ProxyPassReverse /auth http://host.docker.internal:9000/auth

  # MCP Root Endpoints
  <Location /mcp>
    ProxyPass http://host.docker.internal:9000/mcp
    ProxyPassReverse http://host.docker.internal:9000/mcp
    SetEnv proxy-sendchunked 1
    SetEnv proxy-nokeepalive 1
  </Location>

  ProxyPass /tristar http://host.docker.internal:9000/tristar
  ProxyPassReverse /tristar http://host.docker.internal:9000/tristar

  # === API ENDPOINTS ===
  <Location /v1/mcp>
    ProxyPass http://host.docker.internal:9000/v1/mcp
    ProxyPassReverse http://host.docker.internal:9000/v1/mcp
    SetEnv proxy-sendchunked 1
    SetEnv proxy-nokeepalive 1
  </Location>

  ProxyPass /triforce http://host.docker.internal:9000/triforce
  ProxyPassReverse /triforce http://host.docker.internal:9000/triforce

  ProxyPass /v1 http://host.docker.internal:9000/v1
  ProxyPassReverse /v1 http://host.docker.internal:9000/v1

  ProxyPass /docs http://host.docker.internal:9000/docs
  ProxyPassReverse /docs http://host.docker.internal:9000/docs
  ProxyPass /openapi.json http://host.docker.internal:9000/openapi.json
  ProxyPassReverse /openapi.json http://host.docker.internal:9000/openapi.json
  ProxyPass /redoc http://host.docker.internal:9000/redoc
  ProxyPassReverse /redoc http://host.docker.internal:9000/redoc

  ProxyPass /health http://host.docker.internal:9000/health
  ProxyPassReverse /health http://host.docker.internal:9000/health
  ProxyPass /healthz http://host.docker.internal:9000/healthz
  ProxyPassReverse /healthz http://host.docker.internal:9000/healthz
  ProxyPass /hardware http://host.docker.internal:9000/hardware
  ProxyPassReverse /hardware http://host.docker.internal:9000/hardware
  ProxyPass /metrics http://host.docker.internal:9000/metrics
  ProxyPassReverse /metrics http://host.docker.internal:9000/metrics

  # WebSocket Support
  RewriteEngine On
  RewriteCond %{HTTP:Upgrade} =websocket [NC]
  RewriteRule /(.*)           ws://host.docker.internal:9000/$1 [P,L]

  # PUBLIC SEARCH API
  <Location /api/public/search>
    ProxyPass http://host.docker.internal:9000/v1/mcp
    ProxyPassReverse http://host.docker.internal:9000/v1/mcp
    SetEnv proxy-sendchunked 1
  </Location>

  # ============================================================
  # SECURITY HEADERS - Mozilla Observatory A+ Target
  # ============================================================
  <IfModule mod_headers.c>
    # CSP für API (strenger als WordPress)
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self' wss://api.ailinux.me; frame-ancestors 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests"
    
    # HSTS 1 Jahr
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # Clickjacking
    Header always set X-Frame-Options "DENY"
    
    # MIME Sniffing
    Header always set X-Content-Type-Options "nosniff"
    
    # Referrer
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Permissions Policy
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()"
    
    # Cross-Origin Policies
    Header always set Cross-Origin-Opener-Policy "same-origin"
    Header always set Cross-Origin-Resource-Policy "same-origin"
    
    # Remove Server Info
    Header always unset X-Powered-By
    Header always unset Server
  </IfModule>

  Protocols h2 http/1.1
  SSLVerifyClient none

  ErrorLog  "/proc/self/fd/2"
  CustomLog "/proc/self/fd/1" realip
</VirtualHost>
