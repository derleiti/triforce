# ============================================================================
# WordPress VHost für ailinux.me
# Security Headers: Mozilla Observatory A+ Target
# Updated: 2024-12-22 v2
# ============================================================================

<VirtualHost *:80>
  ServerName ailinux.me
  ServerAlias www.ailinux.me
  RewriteEngine On
  RewriteRule ^/(.*)$ https://ailinux.me/$1 [R=301,L]
</VirtualHost>

<VirtualHost *:443>
  ServerName ailinux.me
  ServerAlias www.ailinux.me

  RewriteEngine On
  RewriteCond %{HTTP_HOST} !^ailinux\.me$ [NC]
  RewriteRule ^/(.*)$ https://ailinux.me/$1 [R=301,L]

  SSLEngine on
  SSLCertificateFile      /etc/letsencrypt/live/ailinux.me/fullchain.pem
  SSLCertificateKeyFile   /etc/letsencrypt/live/ailinux.me/privkey.pem
  IncludeOptional conf.d/snippets/ssl-params.conf

  DocumentRoot "/var/www/html"
  <Directory "/var/www/html">
    AllowOverride All
    Require all granted
  </Directory>

  <FilesMatch \.php$>
    SetHandler "proxy:fcgi://wordpress_fpm:9000"
  </FilesMatch>

  DirectoryIndex index.php index.html

  # ============================================================
  # SECURITY HEADERS - Mozilla Observatory A/A+ Target
  # ============================================================
  <IfModule mod_headers.c>
    # CSP - Optimiert für besseren Score
    # - object-src 'none' explizit (wichtig!)
    # - script-src ohne 'unsafe-eval' wo möglich
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.gstatic.com https://pagead2.googlesyndication.com https://tpc.googlesyndication.com https://www.googletagservices.com https://widget.intercom.io https://cdn.gtranslate.net https://translate.google.com https://translate.googleapis.com https://challenges.cloudflare.com https://translate-pa.googleapis.com https://js.intercomcdn.com https://www.youtube.com https://static.addtoany.com https://fundingchoicesmessages.google.com https://ep2.adtrafficquality.google https://cdn.jsdelivr.net https://accounts.google.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https: blob:; font-src 'self' data: https://fonts.gstatic.com; connect-src 'self' https://api.ailinux.me wss://api.ailinux.me https:; frame-src https://www.youtube.com https://accounts.google.com https://challenges.cloudflare.com https://www.google.com https://td.doubleclick.net; worker-src 'self' blob:; media-src 'self' data: https:; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'self'; upgrade-insecure-requests"
    
    # HSTS 1 Jahr + preload
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # Clickjacking (SAMEORIGIN für WordPress Admin)
    Header always set X-Frame-Options "SAMEORIGIN"
    
    # MIME Sniffing
    Header always set X-Content-Type-Options "nosniff"
    
    # Referrer
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Permissions Policy
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), accelerometer=(), gyroscope=(), magnetometer=()"
    
    # Cross-Origin (relaxed für WordPress)
    Header always set Cross-Origin-Opener-Policy "same-origin-allow-popups"
    Header always set Cross-Origin-Resource-Policy "cross-origin"
    
    # Remove Server Info
    Header always unset X-Powered-By
  </IfModule>

  Protocols h2 http/1.1
  SSLVerifyClient none

  ErrorLog  "/proc/self/fd/2"
  CustomLog "/proc/self/fd/1" realip
</VirtualHost>
