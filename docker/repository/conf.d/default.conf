# AILinux Repository Server Config
# repo.ailinux.me - Korrigiert am $(date +%Y-%m-%d)

server {
    listen 8080;
    listen 8443 ssl;
    http2 on;
    server_name repo.ailinux.me localhost;

    # SSL Zertifikate
    ssl_certificate /etc/letsencrypt/live/ailinux.me/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/ailinux.me/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Root f端r Repository
    root /repo;
    autoindex on;
    autoindex_exact_size off;
    autoindex_localtime on;
    autoindex_format html;

    # Index-Datei
    index index.html;

    # Charset
    charset utf-8;

    # Standard Location mit CORS
    location / {
        try_files $uri $uri/ =404;
        
        # CORS Headers
        add_header Access-Control-Allow-Origin $cors_api_origin always;
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Range, Content-Type" always;
    }

    # Mirror-Verzeichnis (existiert!)
    location /mirror/ {
        alias /repo/mirror/;
        autoindex on;
        autoindex_exact_size on;
        autoindex_localtime on;
        
        add_header Access-Control-Allow-Origin $cors_api_origin always;
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
    }

    # GPG Key
    location /ailinux.gpg {
        alias /repo/ailinux.gpg;
        default_type application/pgp-keys;
        add_header Access-Control-Allow-Origin $cors_api_origin always;
    }

    # Add-Repo Script (direkter Pfad)
    location = /add-ailinux-repo.sh {
        alias /repo/mirror/add-ailinux-repo.sh;
        default_type text/plain;
        add_header Access-Control-Allow-Origin $cors_api_origin always;
    }

    # Legacy-Pfad Redirect f端r add-repo Script
    location = /mirror/add-ailinux-repo.sh {
        alias /repo/mirror/add-ailinux-repo.sh;
        default_type text/plain;
        add_header Access-Control-Allow-Origin $cors_api_origin always;
    }

    # Health Check
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }

    # ========================================================
    # DEAKTIVIERT: dists/ und pool/ existieren nicht
    # Wenn APT-Mirror eingerichtet wird, diese aktivieren:
    # ========================================================
    # location /pool/ {
    #     alias /repo/pool/;
    #     autoindex on;
    # }
    #
    # location /dists/ {
    #     alias /repo/dists/;
    #     autoindex on;
    # }

    # Compression f端r Packages
    location ~* \.(gz|bz2|xz|lz4|zst)$ {
        add_header Content-Encoding identity;
    }

    # Cache Headers f端r statische Files
    location ~* \.(deb|udeb|dsc|changes|tar\.gz|tar\.xz)$ {
        expires 7d;
        add_header Cache-Control "public, immutable";
    }
}
